name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # ✅ Step 1: Checkout your code
      - name: Checkout code
        uses: actions/checkout@v3

      # ✅ Step 2: Setup Docker builder
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ✅ Step 3: Log in to Docker Hub using GitHub Secrets
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ✅ Step 4: Build & push backend image
      - name: Build and push backend image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/provertos_backend:latest

      # ✅ Step 5: Build & push frontend image
      - name: Build and push frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/provertos_frontend:latest

      # ✅ Step 6: Install Ansible for deployment
      - name: Install Ansible
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ansible

      # ✅ Step 7: (Optional but Important)
      # Set MongoDB URI secret if needed for your deployment
      - name: Set environment variables
        run: echo "MONGO_URL=${{ secrets.MONGO_URL }}" >> $GITHUB_ENV

      # ✅ Step 8: Run Ansible playbook
      - name: Deploy using Ansible (local)
        if: ${{ !secrets.DEPLOY_HOST }}
        env:
          MONGO_URL: ${{ secrets.MONGO_URL }}
        run: |
          cd infra/ansible
          # default: build images locally on the runner and skip container lifecycle if Terraform manages infra
          ansible-playbook -i hosts.ini playbook.yml -e "use_registry=false manage_containers_with_terraform=true mongo_url='${{ secrets.MONGO_URL }}'"

      - name: Deploy to remote host via SSH (optional)
        if: ${{ secrets.DEPLOY_HOST != '' }}
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || '22' }}
          script: |
            set -e
            echo "Pulling backend image"
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/provertos_backend:latest
            echo "Pulling frontend image"
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/provertos_frontend:latest

            echo "Stopping old containers (if any)"
            docker stop pro_backend || true
            docker rm pro_backend || true
            docker stop pro_frontend || true
            docker rm pro_frontend || true

            echo "Starting backend container"
            docker run -d --name pro_backend -p 5000:4000 --restart unless-stopped -e \"MONGO_URL='${{ secrets.MONGO_URL }}'\" ${{ secrets.DOCKERHUB_USERNAME }}/provertos_backend:latest

            echo "Starting frontend container (nginx)"
            docker run -d --name pro_frontend -p 3000:80 --restart unless-stopped ${{ secrets.DOCKERHUB_USERNAME }}/provertos_frontend:latest

      - name: CI health-check on remote (optional)
        if: ${{ secrets.DEPLOY_HOST != '' }}
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT || '22' }}
          script: |
            set -e
            echo "Checking backend..."
            curl -fS --retry 5 --retry-delay 2 http://localhost:5000/test
            echo "Checking frontend..."
            curl -fS --retry 5 --retry-delay 2 http://localhost:3000
